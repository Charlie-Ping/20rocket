stm32 笔记
==============

> 暂定使用`stm32f103c8t6`

********

内核&存储器
---------

+ 内核
  - arm32 (CISC指令集 
+ 存储器
  +  20k RAM

+ clock, 复位, power
  + 2.0 - 3.6 (3.3 normally)
  + 4-16MHz(系统时钟+RTC) + 32kHZ(RTC) 晶振 
    > RTC是 `实时时钟`, 就是当前年月日
    `系统时钟` 就是运行时所用的时钟, 重启则重置
    还有个 `CPU时钟` 指的是CPU工作频率
  + 俩RC振荡器(内部的稍微弱点的晶振, ) 用于实时时钟
    > 细分的话 大概有:
        `HSI` *可作系统时钟 或 使用PLL调整频率(频率/2 * 2&3&4...&16) 以设置主频, 最高72MHz (16 / 2 * 9)*
        `HSE` *同上* 
        `LSI` *40kHZ, 可作RTC 或 [看门狗](#WatchDog)*
        `LSE` *32kHZ, 可作RTC, 使用 OSC32_IN/OUT 接口*
        [这些英文单词的缩写释义](#ClockTable)
  + PLL
    > PLL(Phase Locked Loop)： 为锁相回路或锁相环，用来统一整合时钟信号，使高频器件正常工作，如内存的存取资料等。PLL用于振荡器中的反馈技术。 许多电子设备要正常工作，通常需要外部的输入信号与内部的振荡信号同步。一般的晶振由于工艺与成本原因，做不到很高的频率，而在需要高频应用时，由相应的器件VCO，实现转成高频，但并不稳定，故利用锁相环路就可以实现稳定且高频的时钟信号。
    
    简单来说就是 (本来低频的)晶振频率plus 以支持高频

  + MCO *Main Clock Output*
    字面意思,输出时钟(然而仍然不懂)

***

低功耗 & ADC
------
+ 低功耗
    - 睡眠 
        关掉arm内核
    - 停机
        睡眠 + 内部所有功能 + PLL + HSE
    - 待机 (基本属于复位)
        停机 + SRAM消失
    - Vbat(一个电池接口) 为`RTC`和`后备寄存器`供电
+ Analog-Digital Converter
  2 个 12 位独立ADC, `1e-6` s转换时间, 16个外部通道
  - **非常有用!** 另有扫描模式, 自己更新+扫描数据
  - DMA操作: ADC不经过ARM CPU 直接将得到的电压值放到SRAM里
输出通道
  + ranges from 0 to 3.6 V
  + 双采样和保持功能
  + 温度传感器(内部)
 

***

DMA & IO端口
-------

+ DMA
  - 7 个通道(啥意思啊?)
  - 支持的外设: 定时器, ADC, SPI, IIC, USART
    > 详见[STM32——简述USART与SPI、IIC之间的区别与联系](https://blog.csdn.net/weixin_37584766/article/details/90114213) ~~(为什么会是CSDN啊kuso!~~
  - 可以直接在设备间传输数据(相较于先传到SRAM而言)
  - DMA是用硬件完成的,不需要CPU参与, :D
  - 80 个 快速IO接口, 映射到16个外部中断[^外部中断], 几乎所有端口都兼容5V信号

+ 通用输入输出接口(GPIO)
  - 最高18MHz高低电平转换
  - 几种工作模式
  
  | Name | Commit |
  | --- | --- |
  | GPIO_Mode_AIN | 模拟输入 |
  | GPIO_Mode_IN_FLOATING | 浮空输入 |
  | ... IPD | 下拉输入 |
  | ... IPD | 上~ |
  | ...Out_PP | 推挽输出 |
  | ... Out_OD | 开漏输出 |
  | ...AF_PP | 复用推挽输出 |
  | ...AF_OD | 复用开漏输出 |



[^外部中断]: 暂停当前工作,做其他事

***

调试模式
-------

> 就是放到单片机里测试的意思

+ 串行单线调试(SWD)和JTAG接口
  + 内嵌于ARM(就是作为引脚对外开放)
  + 通过某些专用(也可复用)的接口和外部通信(以此来debug)
  + JTAG要占ARM的五个引脚, SWD只用俩, 在珍稀的GPIO面前, 我选择SWD
  
***

定时器 (TIM)
---------

> stm32 有7个定时器(可以理解成闹钟, 单位是脉冲频率, 范围1-65535)

+ 3 个 16 位定时器
  
+ 1 个 16 位 带`死区控制`和`紧急刹车`
+ 2 个 看门狗定时器
  > 监控程序cpu, 如果cpu出现错误, 看门狗会复位单片机, 然后cpu重 新执行程序
    cpu正常情况定时喂狗, 不喂(没信号)的时候 则复位
  - 独立看门狗
    12 位的递减计数器 & 8 位的预分频器, 自己有一个RC振荡器提供时钟, 且不受主系统的待机停机模式干扰.
    > 与`窗口看门狗`不同的是, 它还可以作为一个`自由定时器`为软件提供超时管理
  - 窗口看门狗
    7位的递减计数器
  
+ 系统时基定时器: 24位自减型计数器
  - 专用于实时操作系统, 可以当成一个标准的递减计数器
    > 在多任务中, 计时器在每个任务结束后(减到0) cpu切换下一个任务
  - 自动重加载功能
  

***

IIC & USART
---------

+ 2个IIC
  > 多个设备并联一条IIC总线, 主设备通过地址分辨设备
  > 设备可以有独立电源
  - IIC总线, 可工作于多主模式/从模式 
  - 7位~10位寻址
  - 支持DMA
  - 接口: SDA(时钟同步) & SCL(数据传输)
+ 3个USART
  > USART 通用同步/异步收发器(但是很少用同步)
  - 可达 4.5Mbs, 其他接口速率可达2.25Mbs
  - 支持DMA
  - 根据不同电平方式分为`RS232`(20m, 3--12V)和`RS485`(1000m, +-2--6V) *~~完全用不到这么长啊喂~~*
+ 2个SPI
  - 18Mbs
  - 支持SD卡读写, DMA, 八种频率, 
+ CAN接口
  - 自动查错, 1Mbs, 距离远, **稳定**
+ USB 2.0全速接口 
  - 设备控制器
  - 2.0Mbs


***

CRC & 芯片ID
----

+ CRC(循环冗余校验)
  - 发送端和接受端数据各一个, 发送前校验一遍, 发送后校验一遍
  - 校验失败的话 接受端会要求发送端重传
  - 可以理解成类似MD5吗?

+ 芯片ID
  + 96位 == 24位0x数
  + 每个芯片编码唯一
  + 可作通信加密
***

其他功能
----
+ NVIC 嵌套向量中断控制器: 用于总体管理异常
+ EXTI 外部中断/事件控制器: 产生/中断事件请求
+ 自举模式 
  > 复位时, 内部8MHz RC被选为CPU时钟
  也可以手动选择4-16MHz 时钟, 它失效的时候cpu会自动切回使用8MHz RC.
+ AHB 高级高性能总线, 用于CPU, DMA, DSP(数字信号)通信
+ APB 外围总线, 用于内部其他功能通信, 分为高速`APB2`(72MHz)和低速`APB1`(36MHz)

***

附录
------



<div id="ClockTable"><h4>时钟缩写释义</h4></div>

| Char | Means |
| --- | --- |
|`H` | high-speed  |
|`L` |repr low-speed |
|`I` | Internal (RC) |
| `E` | External (Crystal) |



<div id="WatchDog"><h4>WatchDog</h4></div>

TODO~